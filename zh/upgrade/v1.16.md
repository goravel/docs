# 从 v1.15 升级到 v1.16

### 令人兴奋的新功能 🎉

- [新增 facades.DB()](#新增-facades-db)
- [新增 facades.Http()](#新增-facades-http)
- [facades.Auth() 支持自定义驱动](#facades-auth-支持自定义驱动)

### 功能增强 🚀

- [拆分数据库驱动](#拆分数据库驱动)
- [Migration 新增方法](#migration-新增方法)
- [Grpc 新增 Shutdown 方法](#grpc-新增-shutdown-方法)
- [Artisan 新增禁用打印颜色选项](#artisan-新增禁用打印颜色选项)
- [加解密 env 文件](#加解密-env-文件)
- [Fiber 驱动新增 immutable 配置](#fiber-驱动新增-immutable-配置)
- [发送邮件支持设置 Header](#发送邮件支持设置-header)

### 破坏性变化 🛠

- [优化 Config 模块方法默认值类型](#优化-config-模块方法默认值类型)
- [移除 SQL 迁移](#移除-sql-迁移)
- [优化 Orm 模块方法](#优化-orm-模块方法)
- [优化 Path 方法](#优化-path-方法)
- [优化 Request 方法](#优化-request-方法)

## 升级指南

**预计升级时间：10 分钟**

随着 [Golang v1.22 不再被维护](https://endoflife.date/go)，Goravel v1.16 默认支持 Golang 版本由 1.22 升级为 1.23，请在 go.mod 文件中更新版本。

### 1. 更新依赖

```
go get -u github.com/goravel/framework@v1.16.0

// 如果使用 gin
go get -u github.com/goravel/gin@v1.4.0

// 如果使用 fiber
go get -u github.com/goravel/fiber@v1.4.0

// 如果使用 redis
go get -u github.com/goravel/redis@v1.4.0

// 如果使用 S3
go get -u github.com/goravel/s3@v1.4.0

// 如果使用 Oss
go get -u github.com/goravel/oss@v1.4.0

// 如果使用 Cos
go get -u github.com/goravel/cos@v1.4.0

// 如果使用 Minio
go get -u github.com/goravel/minio@v1.4.0

// 如果使用 Cloudinary
go get -u github.com/goravel/cloudinary@v1.4.0
```

```
go mod tidy
```

### 2. 修改数据库配置

删除数据库配置文件 `config/database.go` 中自己用不到的 `connections`，安装自己需要的数据库驱动。

| 数据库类型 | 驱动包 |
| ---------- | ------ |
| Postgres   | github.com/goravel/postgres |
| MySQL      | github.com/goravel/mysql |
| Sqlserver  | github.com/goravel/sqlserver |
| SQLite     | github.com/goravel/sqlite |

For example:

```go
// config/database.go
"connections": map[string]any{
--  "postgres": map[string]any{
--    "host":     config.Env("DB_HOST", "127.0.0.1"),
--    "port":     config.Env("DB_PORT", 5432),
--    "database": config.Env("DB_DATABASE", "forge"),
--    "username": config.Env("DB_USERNAME", ""),
--    "password": config.Env("DB_PASSWORD", ""),
--    "sslmode":  "disable",
--    "timezone": "UTC", // Asia/Shanghai
--    "prefix":   "",
--    "singular": false,
--    "schema":   config.Env("DB_SCHEMA", "public"),
++    "via": func() (driver.Driver, error) {
++      return postgresfacades.Postgres("postgres")
++    },
--  },
--  "mysql": map[string]any{
--    "driver":   "mysql",
--    "host":     config.Env("DB_HOST", "127.0.0.1"),
--    "port":     config.Env("DB_PORT", 3306),
--    "database": config.Env("DB_DATABASE", "forge"),
--    "username": config.Env("DB_USERNAME", ""),
--    "password": config.Env("DB_PASSWORD", ""),
--    "charset":  "utf8mb4",
--    "loc":      "Local",
--    "prefix":   "",
--    "singular": false,
--  },
```

### 3. 修改 auth.go 配置文件

```go
// config/auth.go

// Supported: "jwt"
"guards": map[string]any{
  "user": map[string]any{
    "driver":   "jwt",
++    "provider": "user",
  },
},

++ // Supported: "orm"
++ "providers": map[string]any{
++   "user": map[string]any{
++     "driver": "orm",
++   },
++ },
```

### 4. 如果需要使用 HTTP Client

新增 HTTP Client 配置项:

```go
// config/http.go
++ "client": map[string]any{
++   "base_url":                config.GetString("HTTP_CLIENT_BASE_URL"),
++   "timeout":                 config.GetDuration("HTTP_CLIENT_TIMEOUT"),
++   "max_idle_conns":          config.GetInt("HTTP_CLIENT_MAX_IDLE_CONNS"),
++   "max_idle_conns_per_host": config.GetInt("HTTP_CLIENT_MAX_IDLE_CONNS_PER_HOST"),
++   "max_conns_per_host":      config.GetInt("HTTP_CLIENT_MAX_CONN_PER_HOST"),
++   "idle_conn_timeout":       config.GetDuration("HTTP_CLIENT_IDLE_CONN_TIMEOUT"),
++ },
```

### 5. 检查 Config 模块

如果正在使用 Config 模块，请检查以下方法的默认值类型是否正确：

- `GetString`
- `GetInt`
- `GetBool`

需相应修改：[修改 Config Moudlue 方法默认值类型](#修改-config-moudlue-方法默认值类型)

### 6. 如果正在使用 SQL 数据迁移

需相应修改：[移除 SQL 迁移](#移除-sql-迁移)

### 7. 如果正在使用 Orm 模块

需相应修改：[优化 Orm 模块方法](#优化-orm-模块方法)

### 8. 如果正在使用 Path 方法

需相应修改：[优化 Path 方法](#优化-path-方法)

### 9. 如果 正在使用 `ctx.Request().InputMap` 方法

需相应修改：[优化 Request 方法](#优化-request-方法)

## 功能介绍

### 新增 facades.DB()

新增 `facades.DB()` 模块，方便进行数据库的原生操作，比 ORM 速度更快。

[查看文档](../database/getting-started.md)

### HTTP 客户端

新增一个内置的 HTTP 客户端 `facades.Http()`，让 API 调用变得轻而易举。

[查看文档](../digging-deeper/http-client.md)

### facades.Auth() 支持自定义驱动

[查看文档](../security/authentication.md)

### 拆分数据库驱动

之前多个数据库驱动同时集成在框架中，使得软件打包体积变大，从 v1.16 开始，数据库驱动将作为独立包存在，只需安装自己需要的数据库驱动即可。

| 数据库类型 | 驱动包 |
| ---------- | ------ |
| Postgres   | github.com/goravel/postgres |
| MySQL      | github.com/goravel/mysql |
| Sqlserver  | github.com/goravel/sqlserver |
| SQLite     | github.com/goravel/sqlite |

### Migration 新增方法

新增 `Change` 方法（适用于 Postgres, MySQL, MsSQL），用于修改表结构：

```go
table.String("name").Change()
```

新增 `RenameColumn` 方法，用于重命名表列：

```go
table.RenameColumn("old_name", "new_name")
```

新增 `Comment` 方法，用于为表添加注释（适用于 Postgres, MySQL）：

```go
table.Comment("user table")
```

新增 `First` 方法，用于将字段设置为表的第一个字段（适用于 MySQL）：

```go
table.String("name").First()
```

新增 `After` 方法，用于将字段设置为表的最后一个字段（适用于 MySQL）：

```go
table.String("name").After("id")
```

### Grpc 新增 Shutdown 方法

使得可以优雅的关闭 Grpc。

[查看文档](../the-basics/grpc.md#关闭grpc)

### Artisan 新增禁用打印颜色选项

有些命令默认会打印颜色，例如 `list` 命令，但在某些终端或日志中颜色值会是乱码，这时你可以使用 `--no-ansi` 选项禁用打印颜色：

```shell
go run . artisan list --no-ansi
```

### 加解密 env 文件

你也许想将生产环境的 env 文件添加到版本控制中，但又不想将敏感信息暴露出来，这时你可以加解密 env 文件。

[查看文档](../getting-started/installation.md#加解密-env-文件)

### Fiber 驱动新增 immutable 配置

新增 `immutable` 配置，用于设置 Fiber 驱动是否为不可变模式，默认值为 `true`。

```
"fiber": map[string]any{
    ++ // immutable mode, see https://docs.gofiber.io/#zero-allocation
    ++ // WARNING: This option is dangerous. Only change it if you fully understand the potential consequences.
    ++ "immutable": true,
    // prefork mode, see https://docs.gofiber.io/api/fiber/#config
    "prefork": false,
    ...
},
```

### 发送邮件支持设置 Header

新增 `Headers` 方法，用于设置邮件的 Header。

```go
facades.Mail().Headers(map[string]string{"X-Mailer": "Goravel"})
```

### 移除 SQL 迁移

SQL 迁移被完全移除，请使用 Go 语言迁移。迁移步骤：

1. 移除 `config/database.go` 中的 `migrations.driver` 键；
2. 将 `database/migrations` 目录下的 SQL 迁移文件转换为 Go 语言迁移文件：

```go
// Up Run the migrations.
func (r *M20241207095921CreateUsersTable) Up() error {
  return facades.Schema().Sql({Original SQL})
}

// Down Reverse the migrations.
func (r *M20241207095921CreateUsersTable) Down() error {
  return facades.Schema().Sql({Original SQL})
}
```

3. 在 `database/kernel.go` 文件中注册迁移文件；

### 优化 Config 模块方法默认值类型

之前 `GetString`、`GetInt`、`GetBool` 方法的默认值类型为 `any`，从 v1.16 开始，默认值类型为 `string`、`int`、`bool`，以保证类型安全。

```
-- GetString(path string, defaultValue ...any) string
++ GetString(path string, defaultValue ...string) string

-- GetInt(path string, defaultValue ...any) int
++ GetInt(path string, defaultValue ...int) int

-- GetBool(path string, defaultValue ...any) bool
++ GetBool(path string, defaultValue ...bool) bool
```

### 优化 Orm 模块方法

优化 `Count`, `Exists` 方法返回值：

```go
-- Count(count *int64) error
++ Count() (int64, error)

-- Exists(exists *bool) error
++ Exists() (bool, error)
```

### 优化 Path 方法

1. 新增 `Resource` 方法；
2. 之前 path 方法返回的是相对于根目录的路径，例如 `path.Config("app.go") == config/app.go`，从 v1.16 开始，path 方法返回的是绝对路径，例如 `path.Config("app.go") == /Users/goravel/workspace/goravel/config/app.go`；

### 优化 Request 方法

1. 修改 `InputMap` 方法默认值类型：

```go
-- ctx.Request().InputMap(key string, defaultValue ...map[string]string) map[string]string
++ ctx.Request().InputMap(key string, defaultValue ...map[string]any) map[string]any
```

2. 新增 `InputMapArray` 方法，用于获取数组类型的 Map：

```go
ctx.Request().InputMapArray(key string, defaultValue ...[]map[string]any) []map[string]any
```
