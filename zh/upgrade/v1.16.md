# ä» v1.15 å‡çº§åˆ° v1.16

### ä»¤äººå…´å¥‹çš„æ–°åŠŸèƒ½ ğŸ‰

- [æ–°å¢ facades.DB()](#æ–°å¢-facades-db)
- [æ–°å¢ facades.Http()](#æ–°å¢-facades-http)
- [facades.Auth() æ”¯æŒè‡ªå®šä¹‰é©±åŠ¨](#facades-auth-æ”¯æŒè‡ªå®šä¹‰é©±åŠ¨)

### åŠŸèƒ½å¢å¼º ğŸš€

- [æ‹†åˆ†æ•°æ®åº“é©±åŠ¨](#æ‹†åˆ†æ•°æ®åº“é©±åŠ¨)
- [Migration æ–°å¢æ–¹æ³•](#migration-æ–°å¢æ–¹æ³•)
- [Grpc æ–°å¢ Shutdown æ–¹æ³•](#grpc-æ–°å¢-shutdown-æ–¹æ³•)
- [Artisan æ–°å¢ç¦ç”¨æ‰“å°é¢œè‰²é€‰é¡¹](#artisan-æ–°å¢ç¦ç”¨æ‰“å°é¢œè‰²é€‰é¡¹)
- [åŠ è§£å¯† env æ–‡ä»¶](#åŠ è§£å¯†-env-æ–‡ä»¶)
- [Fiber é©±åŠ¨æ–°å¢ immutable é…ç½®](#fiber-é©±åŠ¨æ–°å¢-immutable-é…ç½®)
- [å‘é€é‚®ä»¶æ”¯æŒè®¾ç½® Header](#å‘é€é‚®ä»¶æ”¯æŒè®¾ç½®-header)

### ç ´åæ€§å˜åŒ– ğŸ› 

- [ä¼˜åŒ– Config æ¨¡å—æ–¹æ³•é»˜è®¤å€¼ç±»å‹](#ä¼˜åŒ–-config-æ¨¡å—æ–¹æ³•é»˜è®¤å€¼ç±»å‹)
- [ç§»é™¤ SQL è¿ç§»](#ç§»é™¤-sql-è¿ç§»)
- [ä¼˜åŒ– Orm æ¨¡å—æ–¹æ³•](#ä¼˜åŒ–-orm-æ¨¡å—æ–¹æ³•)
- [ä¼˜åŒ– Path æ–¹æ³•](#ä¼˜åŒ–-path-æ–¹æ³•)
- [ä¼˜åŒ– Request æ–¹æ³•](#ä¼˜åŒ–-request-æ–¹æ³•)

## å‡çº§æŒ‡å—

**é¢„è®¡å‡çº§æ—¶é—´ï¼š10 åˆ†é’Ÿ**

éšç€ [Golang v1.22 ä¸å†è¢«ç»´æŠ¤](https://endoflife.date/go)ï¼ŒGoravel v1.16 é»˜è®¤æ”¯æŒ Golang ç‰ˆæœ¬ç”± 1.22 å‡çº§ä¸º 1.23ï¼Œè¯·åœ¨ go.mod æ–‡ä»¶ä¸­æ›´æ–°ç‰ˆæœ¬ã€‚

### 1. æ›´æ–°ä¾èµ–

```
go get -u github.com/goravel/framework@v1.16.0

// å¦‚æœä½¿ç”¨ gin
go get -u github.com/goravel/gin@v1.4.0

// å¦‚æœä½¿ç”¨ fiber
go get -u github.com/goravel/fiber@v1.4.0

// å¦‚æœä½¿ç”¨ redis
go get -u github.com/goravel/redis@v1.4.0

// å¦‚æœä½¿ç”¨ S3
go get -u github.com/goravel/s3@v1.4.0

// å¦‚æœä½¿ç”¨ Oss
go get -u github.com/goravel/oss@v1.4.0

// å¦‚æœä½¿ç”¨ Cos
go get -u github.com/goravel/cos@v1.4.0

// å¦‚æœä½¿ç”¨ Minio
go get -u github.com/goravel/minio@v1.4.0

// å¦‚æœä½¿ç”¨ Cloudinary
go get -u github.com/goravel/cloudinary@v1.4.0
```

```
go mod tidy
```

### 2. ä¿®æ”¹æ•°æ®åº“é…ç½®

åˆ é™¤æ•°æ®åº“é…ç½®æ–‡ä»¶ `config/database.go` ä¸­è‡ªå·±ç”¨ä¸åˆ°çš„ `connections`ï¼Œå®‰è£…è‡ªå·±éœ€è¦çš„æ•°æ®åº“é©±åŠ¨ã€‚

| æ•°æ®åº“ç±»å‹ | é©±åŠ¨åŒ… |
| ---------- | ------ |
| Postgres   | github.com/goravel/postgres |
| MySQL      | github.com/goravel/mysql |
| Sqlserver  | github.com/goravel/sqlserver |
| SQLite     | github.com/goravel/sqlite |

For example:

```go
// config/database.go
"connections": map[string]any{
--  "postgres": map[string]any{
--    "host":     config.Env("DB_HOST", "127.0.0.1"),
--    "port":     config.Env("DB_PORT", 5432),
--    "database": config.Env("DB_DATABASE", "forge"),
--    "username": config.Env("DB_USERNAME", ""),
--    "password": config.Env("DB_PASSWORD", ""),
--    "sslmode":  "disable",
--    "timezone": "UTC", // Asia/Shanghai
--    "prefix":   "",
--    "singular": false,
--    "schema":   config.Env("DB_SCHEMA", "public"),
++    "via": func() (driver.Driver, error) {
++      return postgresfacades.Postgres("postgres")
++    },
--  },
--  "mysql": map[string]any{
--    "driver":   "mysql",
--    "host":     config.Env("DB_HOST", "127.0.0.1"),
--    "port":     config.Env("DB_PORT", 3306),
--    "database": config.Env("DB_DATABASE", "forge"),
--    "username": config.Env("DB_USERNAME", ""),
--    "password": config.Env("DB_PASSWORD", ""),
--    "charset":  "utf8mb4",
--    "loc":      "Local",
--    "prefix":   "",
--    "singular": false,
--  },
```

### 3. ä¿®æ”¹ auth.go é…ç½®æ–‡ä»¶

```go
// config/auth.go

// Supported: "jwt"
"guards": map[string]any{
  "user": map[string]any{
    "driver":   "jwt",
++    "provider": "user",
  },
},

++ // Supported: "orm"
++ "providers": map[string]any{
++   "user": map[string]any{
++     "driver": "orm",
++   },
++ },
```

### 4. å¦‚æœéœ€è¦ä½¿ç”¨ HTTP Client

æ–°å¢ HTTP Client é…ç½®é¡¹:

```go
// config/http.go
++ "client": map[string]any{
++   "base_url":                config.GetString("HTTP_CLIENT_BASE_URL"),
++   "timeout":                 config.GetDuration("HTTP_CLIENT_TIMEOUT"),
++   "max_idle_conns":          config.GetInt("HTTP_CLIENT_MAX_IDLE_CONNS"),
++   "max_idle_conns_per_host": config.GetInt("HTTP_CLIENT_MAX_IDLE_CONNS_PER_HOST"),
++   "max_conns_per_host":      config.GetInt("HTTP_CLIENT_MAX_CONN_PER_HOST"),
++   "idle_conn_timeout":       config.GetDuration("HTTP_CLIENT_IDLE_CONN_TIMEOUT"),
++ },
```

### 5. æ£€æŸ¥ Config æ¨¡å—

å¦‚æœæ­£åœ¨ä½¿ç”¨ Config æ¨¡å—ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹æ–¹æ³•çš„é»˜è®¤å€¼ç±»å‹æ˜¯å¦æ­£ç¡®ï¼š

- `GetString`
- `GetInt`
- `GetBool`

éœ€ç›¸åº”ä¿®æ”¹ï¼š[ä¿®æ”¹ Config Moudlue æ–¹æ³•é»˜è®¤å€¼ç±»å‹](#ä¿®æ”¹-config-moudlue-æ–¹æ³•é»˜è®¤å€¼ç±»å‹)

### 6. å¦‚æœæ­£åœ¨ä½¿ç”¨ SQL æ•°æ®è¿ç§»

éœ€ç›¸åº”ä¿®æ”¹ï¼š[ç§»é™¤ SQL è¿ç§»](#ç§»é™¤-sql-è¿ç§»)

### 7. å¦‚æœæ­£åœ¨ä½¿ç”¨ Orm æ¨¡å—

éœ€ç›¸åº”ä¿®æ”¹ï¼š[ä¼˜åŒ– Orm æ¨¡å—æ–¹æ³•](#ä¼˜åŒ–-orm-æ¨¡å—æ–¹æ³•)

### 8. å¦‚æœæ­£åœ¨ä½¿ç”¨ Path æ–¹æ³•

éœ€ç›¸åº”ä¿®æ”¹ï¼š[ä¼˜åŒ– Path æ–¹æ³•](#ä¼˜åŒ–-path-æ–¹æ³•)

### 9. å¦‚æœ æ­£åœ¨ä½¿ç”¨ `ctx.Request().InputMap` æ–¹æ³•

éœ€ç›¸åº”ä¿®æ”¹ï¼š[ä¼˜åŒ– Request æ–¹æ³•](#ä¼˜åŒ–-request-æ–¹æ³•)

## åŠŸèƒ½ä»‹ç»

### æ–°å¢ facades.DB()

æ–°å¢ `facades.DB()` æ¨¡å—ï¼Œæ–¹ä¾¿è¿›è¡Œæ•°æ®åº“çš„åŸç”Ÿæ“ä½œï¼Œæ¯” ORM é€Ÿåº¦æ›´å¿«ã€‚

[æŸ¥çœ‹æ–‡æ¡£](../database/getting-started.md)

### HTTP å®¢æˆ·ç«¯

æ–°å¢ä¸€ä¸ªå†…ç½®çš„ HTTP å®¢æˆ·ç«¯ `facades.Http()`ï¼Œè®© API è°ƒç”¨å˜å¾—è½»è€Œæ˜“ä¸¾ã€‚

[æŸ¥çœ‹æ–‡æ¡£](../digging-deeper/http-client.md)

### facades.Auth() æ”¯æŒè‡ªå®šä¹‰é©±åŠ¨

[æŸ¥çœ‹æ–‡æ¡£](../security/authentication.md)

### æ‹†åˆ†æ•°æ®åº“é©±åŠ¨

ä¹‹å‰å¤šä¸ªæ•°æ®åº“é©±åŠ¨åŒæ—¶é›†æˆåœ¨æ¡†æ¶ä¸­ï¼Œä½¿å¾—è½¯ä»¶æ‰“åŒ…ä½“ç§¯å˜å¤§ï¼Œä» v1.16 å¼€å§‹ï¼Œæ•°æ®åº“é©±åŠ¨å°†ä½œä¸ºç‹¬ç«‹åŒ…å­˜åœ¨ï¼Œåªéœ€å®‰è£…è‡ªå·±éœ€è¦çš„æ•°æ®åº“é©±åŠ¨å³å¯ã€‚

| æ•°æ®åº“ç±»å‹ | é©±åŠ¨åŒ… |
| ---------- | ------ |
| Postgres   | github.com/goravel/postgres |
| MySQL      | github.com/goravel/mysql |
| Sqlserver  | github.com/goravel/sqlserver |
| SQLite     | github.com/goravel/sqlite |

### Migration æ–°å¢æ–¹æ³•

æ–°å¢ `Change` æ–¹æ³•ï¼ˆé€‚ç”¨äº Postgres, MySQL, MsSQLï¼‰ï¼Œç”¨äºä¿®æ”¹è¡¨ç»“æ„ï¼š

```go
table.String("name").Change()
```

æ–°å¢ `RenameColumn` æ–¹æ³•ï¼Œç”¨äºé‡å‘½åè¡¨åˆ—ï¼š

```go
table.RenameColumn("old_name", "new_name")
```

æ–°å¢ `Comment` æ–¹æ³•ï¼Œç”¨äºä¸ºè¡¨æ·»åŠ æ³¨é‡Šï¼ˆé€‚ç”¨äº Postgres, MySQLï¼‰ï¼š

```go
table.Comment("user table")
```

æ–°å¢ `First` æ–¹æ³•ï¼Œç”¨äºå°†å­—æ®µè®¾ç½®ä¸ºè¡¨çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼ˆé€‚ç”¨äº MySQLï¼‰ï¼š

```go
table.String("name").First()
```

æ–°å¢ `After` æ–¹æ³•ï¼Œç”¨äºå°†å­—æ®µè®¾ç½®ä¸ºè¡¨çš„æœ€åä¸€ä¸ªå­—æ®µï¼ˆé€‚ç”¨äº MySQLï¼‰ï¼š

```go
table.String("name").After("id")
```

### Grpc æ–°å¢ Shutdown æ–¹æ³•

ä½¿å¾—å¯ä»¥ä¼˜é›…çš„å…³é—­ Grpcã€‚

[æŸ¥çœ‹æ–‡æ¡£](../the-basics/grpc.md#å…³é—­grpc)

### Artisan æ–°å¢ç¦ç”¨æ‰“å°é¢œè‰²é€‰é¡¹

æœ‰äº›å‘½ä»¤é»˜è®¤ä¼šæ‰“å°é¢œè‰²ï¼Œä¾‹å¦‚ `list` å‘½ä»¤ï¼Œä½†åœ¨æŸäº›ç»ˆç«¯æˆ–æ—¥å¿—ä¸­é¢œè‰²å€¼ä¼šæ˜¯ä¹±ç ï¼Œè¿™æ—¶ä½ å¯ä»¥ä½¿ç”¨ `--no-ansi` é€‰é¡¹ç¦ç”¨æ‰“å°é¢œè‰²ï¼š

```shell
go run . artisan list --no-ansi
```

### åŠ è§£å¯† env æ–‡ä»¶

ä½ ä¹Ÿè®¸æƒ³å°†ç”Ÿäº§ç¯å¢ƒçš„ env æ–‡ä»¶æ·»åŠ åˆ°ç‰ˆæœ¬æ§åˆ¶ä¸­ï¼Œä½†åˆä¸æƒ³å°†æ•æ„Ÿä¿¡æ¯æš´éœ²å‡ºæ¥ï¼Œè¿™æ—¶ä½ å¯ä»¥åŠ è§£å¯† env æ–‡ä»¶ã€‚

[æŸ¥çœ‹æ–‡æ¡£](../getting-started/installation.md#åŠ è§£å¯†-env-æ–‡ä»¶)

### Fiber é©±åŠ¨æ–°å¢ immutable é…ç½®

æ–°å¢ `immutable` é…ç½®ï¼Œç”¨äºè®¾ç½® Fiber é©±åŠ¨æ˜¯å¦ä¸ºä¸å¯å˜æ¨¡å¼ï¼Œé»˜è®¤å€¼ä¸º `true`ã€‚

```
"fiber": map[string]any{
    ++ // immutable mode, see https://docs.gofiber.io/#zero-allocation
    ++ // WARNING: This option is dangerous. Only change it if you fully understand the potential consequences.
    ++ "immutable": true,
    // prefork mode, see https://docs.gofiber.io/api/fiber/#config
    "prefork": false,
    ...
},
```

### å‘é€é‚®ä»¶æ”¯æŒè®¾ç½® Header

æ–°å¢ `Headers` æ–¹æ³•ï¼Œç”¨äºè®¾ç½®é‚®ä»¶çš„ Headerã€‚

```go
facades.Mail().Headers(map[string]string{"X-Mailer": "Goravel"})
```

### ç§»é™¤ SQL è¿ç§»

SQL è¿ç§»è¢«å®Œå…¨ç§»é™¤ï¼Œè¯·ä½¿ç”¨ Go è¯­è¨€è¿ç§»ã€‚è¿ç§»æ­¥éª¤ï¼š

1. ç§»é™¤ `config/database.go` ä¸­çš„ `migrations.driver` é”®ï¼›
2. å°† `database/migrations` ç›®å½•ä¸‹çš„ SQL è¿ç§»æ–‡ä»¶è½¬æ¢ä¸º Go è¯­è¨€è¿ç§»æ–‡ä»¶ï¼š

```go
// Up Run the migrations.
func (r *M20241207095921CreateUsersTable) Up() error {
  return facades.Schema().Sql({Original SQL})
}

// Down Reverse the migrations.
func (r *M20241207095921CreateUsersTable) Down() error {
  return facades.Schema().Sql({Original SQL})
}
```

3. åœ¨ `database/kernel.go` æ–‡ä»¶ä¸­æ³¨å†Œè¿ç§»æ–‡ä»¶ï¼›

### ä¼˜åŒ– Config æ¨¡å—æ–¹æ³•é»˜è®¤å€¼ç±»å‹

ä¹‹å‰ `GetString`ã€`GetInt`ã€`GetBool` æ–¹æ³•çš„é»˜è®¤å€¼ç±»å‹ä¸º `any`ï¼Œä» v1.16 å¼€å§‹ï¼Œé»˜è®¤å€¼ç±»å‹ä¸º `string`ã€`int`ã€`bool`ï¼Œä»¥ä¿è¯ç±»å‹å®‰å…¨ã€‚

```
-- GetString(path string, defaultValue ...any) string
++ GetString(path string, defaultValue ...string) string

-- GetInt(path string, defaultValue ...any) int
++ GetInt(path string, defaultValue ...int) int

-- GetBool(path string, defaultValue ...any) bool
++ GetBool(path string, defaultValue ...bool) bool
```

### ä¼˜åŒ– Orm æ¨¡å—æ–¹æ³•

ä¼˜åŒ– `Count`, `Exists` æ–¹æ³•è¿”å›å€¼ï¼š

```go
-- Count(count *int64) error
++ Count() (int64, error)

-- Exists(exists *bool) error
++ Exists() (bool, error)
```

### ä¼˜åŒ– Path æ–¹æ³•

1. æ–°å¢ `Resource` æ–¹æ³•ï¼›
2. ä¹‹å‰ path æ–¹æ³•è¿”å›çš„æ˜¯ç›¸å¯¹äºæ ¹ç›®å½•çš„è·¯å¾„ï¼Œä¾‹å¦‚ `path.Config("app.go") == config/app.go`ï¼Œä» v1.16 å¼€å§‹ï¼Œpath æ–¹æ³•è¿”å›çš„æ˜¯ç»å¯¹è·¯å¾„ï¼Œä¾‹å¦‚ `path.Config("app.go") == /Users/goravel/workspace/goravel/config/app.go`ï¼›

### ä¼˜åŒ– Request æ–¹æ³•

1. ä¿®æ”¹ `InputMap` æ–¹æ³•é»˜è®¤å€¼ç±»å‹ï¼š

```go
-- ctx.Request().InputMap(key string, defaultValue ...map[string]string) map[string]string
++ ctx.Request().InputMap(key string, defaultValue ...map[string]any) map[string]any
```

2. æ–°å¢ `InputMapArray` æ–¹æ³•ï¼Œç”¨äºè·å–æ•°ç»„ç±»å‹çš„ Mapï¼š

```go
ctx.Request().InputMapArray(key string, defaultValue ...[]map[string]any) []map[string]any
```
