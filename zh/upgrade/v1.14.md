# 从 v1.13 升级到 v1.14

### 令人兴奋的新功能 🎉

- [数据填充](#数据填充)

### 功能增强 🚀

- [Validation 自动将请求体转换为目标类型](#validation-自动将请求体转换为目标类型)

### 破坏性变化 🛠

- [移除默认加载的 HTTP 全局中间件](#_5-移除默认加载的-http-全局中间件)

### Bug 修复 🐛

- [修复 facades.Auth().User() 的问题](#修复-facades-auth-user-的问题)

## 升级指南

请根据本节内容，一步步进行框架升级。

**预计升级时间：10 分钟**

### 1. 更新依赖

`go.mod` 中更新依赖：

```
go get -u github.com/goravel/framework@v1.13.9 && go get -u github.com/goravel/gin
```

### 2. 新增文件

[tests](https://github.com/goravel/goravel/tree/v1.13.x/tests)

[database/seeders/database_seeder.go](https://github.com/goravel/goravel/tree/v1.13.x/database/seeders/database_seeder.go)

[app/providers/database_service_provider.go](https://github.com/goravel/goravel/tree/v1.13.x/app/providers/database_service_provider.go)

### 3. 注册新的 Provider

注意顺序：

```go
import (
  "github.com/goravel/framework/testing"
  "github.com/goravel/gin"
)

// config/app.go
"providers": []foundation.ServiceProvider{
  ...
  &validation.ServiceProvider{},
  // New
  &testing.ServiceProvider{}, 
  &providers.AppServiceProvider{},
  ...
  &providers.ValidationServiceProvider{},
  // New
  &providers.DatabaseServiceProvider{}, 
  // New
  &gin.ServiceProvider{}, 
}
```

### 4. 新增配置

修改 [config/http.go](https://github.com/goravel/goravel/tree/v1.13.x/config/http.go)

```go
import (
  "github.com/goravel/framework/contracts/route"
  "github.com/goravel/framework/facades"
  ginfacades "github.com/goravel/gin/facades"
)

config.Add("http", map[string]any{
  // HTTP Driver
  "default": "gin",
  // HTTP Drivers
  "drivers": map[string]any{
    "gin": map[string]any{
      "route": func() (route.Route, error) {
        return ginfacades.Route("gin"), nil
      },
    },
  },
  ...
}
```

修改 [config/cors.go](https://github.com/goravel/goravel/tree/v1.13.x/config/cors.go)

```go
config.Add("cors", map[string]any{
  ...
  // New
  "paths":                []string{"*"}, 
  "allowed_methods":      []string{"*"},
  ...
}
```

### 5. 移除默认加载的 HTTP 全局中间件

1. `tls` 与 `cors` 中间件已集成至默认 HTTP 驱动中，因此 `app/http/kernel.go` 文件中的 `middleware.Cors()` 与 `middleware.Tls()` 需被移除。

2. `app/providers/route_service_provider.go` 文件中 `facades.Route().GlobalMiddleware(http.Kernel{}.Middleware()...)` 方法从 `Register` 移动至 `Boot`:

```go
package providers

...

type RouteServiceProvider struct {
}

func (receiver *RouteServiceProvider) Register(app foundation.Application) {
}

func (receiver *RouteServiceProvider) Boot(app foundation.Application) {
  //Add HTTP middleware
  facades.Route().GlobalMiddleware(http.Kernel{}.Middleware()...)

  receiver.configureRateLimiting()

  routes.Web()
}

func (receiver *RouteServiceProvider) configureRateLimiting() {

}
```

### 6. 优化 Controller 返回

`Controller` 增加返回值 `http.Response`，`ctx.Response()` 可直接返回，不需要再单独 `return`，使逻辑更加流畅：

```go
// Before
func (r *UserController) Show(ctx http.Context) {
  ctx.Response().Success().Json(http.Json{
    "Hello": "Goravel",
  })
  return
}

// After
func (r *UserController) Show(ctx http.Context) http.Response {
  return ctx.Response().Success().Json(http.Json{
    "Hello": "Goravel",
  })
}
```

### 7. 修改 facades.Route() 中 Group 方法的入参

`route.Route` 修改为 `route.Router`：

```go
// Before
facades.Route().Group(func(route route.Route)

// After
facades.Route().Group(func(route route.Router)
```

### 8. 修改 facades.Cache() 中 Remember 与 RememberForever 方法（如果用到）

`callback` 类型由 `func() any` 修改为 `func() (any, error)`：

```go
// Before
Remember(key string, ttl time.Duration, callback func() any) (any, error)
RememberForever(key string, callback func() any) (any, error)

// After
Remember(key string, ttl time.Duration, callback func() (any, error)) (any, error)
RememberForever(key string, callback func() (any, error)) (any, error)
```

### 9. 修改 access.NewAllowResponse 与 access.NewDenyResponse 包名（如果用到）

由 `/contracts/auth/access` 修改为 `/auth/access`:

```go
// Before
import "github.com/goravel/framework/contracts/auth/access"

access.NewAllowResponse()
access.NewDenyResponse()

// After
import "github.com/goravel/framework/auth/access"

access.NewAllowResponse()
access.NewDenyResponse()
```

### 10. 移除废弃方法（如果用到）

1. 移除 `ctx.Request().Form()` 和 `ctx.Request().Json()` 方法，使用 `ctx.Request().Input()` 方法替代；

2. 移除 `Log` 自定义驱动的 `GetLevel`, `GetTime`, `GetMessage` 方法，使用 `Level`, `Time`, `Message` 方法替代；

3. 移除 `gorm.New` 方法，该方法用于直接获取 `gorm` 实例，已不推荐使用，如有必要，请使用 `gorm.NewGormImpl` 方法替代；

## 功能介绍

### Validation 自动将请求体转换为目标类型

Version: v1.14.0

