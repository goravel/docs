# 从 v1.12 升级到 v1.13

[[toc]]

### 令人兴奋的新功能 🎉

- [数据填充](#数据填充)
- [模型工厂](#模型工厂)
- [集成测试](#集成测试)

### 功能增强 🚀

- [任务调度支持横向伸缩](#任务调度支持横向伸缩)
- [新增 debug 方法](#新增-debug-方法)
- [make:controller 命令新增参数](#make-controller-命令新增参数)
- [Response 新增 Status 方法](#response-新增-status-方法)
- [Orm 新增 Sum 和 Cursor 方法](#orm-新增-sum-和-cursor-方法)

### 破坏性变化 🛠

- [优化 facades.Cache() 中 Remember 与 RememberForever 方法](#5--修改-facades-cache-中-remember-与-rememberforever-方法（如果用到）)

### Bug 修复 🐛

- [修复 facades.Auth().User() 的问题](#修复-facades-auth-user-的问题)
- [修复自定义 .env 路由某些情况下不生效的问题](#修复自定义-env-路由某些情况下不生效的问题)

## 升级指南

请根据本节内容，一步步进行框架升级。

**预计升级时间：5 分钟**

### 1. 更新依赖

`go.mod` 中更新依赖：

```
go get -u github.com/goravel/framework@v1.13.0 && go mod tidy
```

### 2. 新增 `database/seeders/database_seeder.go` 文件

```go
package seeders

type DatabaseSeeder struct {
}

// Signature The name and signature of the seeder.
func (s *DatabaseSeeder) Signature() string {
  return "DatabaseSeeder"
}

// Run executes the seeder logic.
func (s *DatabaseSeeder) Run() error {
  return nil
}
```

### 3. 新增 `app/providers/database_service_provider.go` 文件

```go
package providers

import (
  "github.com/goravel/framework/contracts/database/seeder"
  "github.com/goravel/framework/contracts/foundation"
  "github.com/goravel/framework/facades"

  "goravel/database/seeders"
)

type DatabaseServiceProvider struct {
}

func (receiver *DatabaseServiceProvider) Register(app foundation.Application) {

}

func (receiver *DatabaseServiceProvider) Boot(app foundation.Application) {
  facades.Seeder().Register([]seeder.Seeder{
    &seeders.DatabaseSeeder{},
  })
}
```

### 4. 新增 `tests` 文件夹

[查看详情](https://github.com/goravel/goravel/tree/master/tests)

### 5. 注册新的 Provider

注意顺序：

```go
// config/app.go
"providers": []foundation.ServiceProvider{
  ...
  &validation.ServiceProvider{},
  // New
	&testing.ServiceProvider{},
	&providers.AppServiceProvider{},
  ...
  &providers.ValidationServiceProvider{},
  // New
  &providers.DatabaseServiceProvider{},
}
```

### 6. 修改 facades.Cache() 中 Remember 与 RememberForever 方法（如果用到）

`callback` 类型由 `func() any` 修改为 `func() (any, error)`：

```go
// 修改前
Remember(key string, ttl time.Duration, callback func() any) (any, error)
RememberForever(key string, callback func() any) (any, error)

// 修改后
Remember(key string, ttl time.Duration, callback func() (any, error)) (any, error)
RememberForever(key string, callback func() (any, error)) (any, error)
```

## 功能介绍

### 数据填充

Version: v1.13.0

[查看文档](../orm/seeding.md)

### 模型工厂

Version: v1.13.0

[查看文档](../orm/factories.md)

### 集成测试

Version: v1.13.0

[查看文档](../testing/getting-started.md)

### 任务调度支持横向伸缩

Version: v1.13.0

[查看文档](../digging-deeper/task-scheduling.md#任务只运行在一台服务器上)

### 新增 debug 方法

Version: v1.13.0

[查看文档](../digging-deeper/helpers.md#debug)

### make:controller 命令新增参数

Version: v1.13.0

`make:controller` 命令新增 `--resource` 参数，可以便捷的生成 CURD struct：

```
go run . artisan make:controller --resource UserController
```

### Response 新增 Status 方法

Version: v1.13.0

[查看文档](../the-basics/response.md#自定义-code)

### Orm 新增 Sum 和 Cursor 方法

Version: v1.13.0

[查看文档](../orm/getting-started.md#facadesormquery--facadesormtransaction-可用方法)

### 修复 facades.Auth().User() 的问题

Version: v1.13.0

1. 修复使用 `facades.Auth().User(ctx, &user)` 方法时，如果 `user` 不存在不抛出错误的问题。

2. 修复当主键非 `int` 类型时，无法找到 `user` 的问题；

### 修复自定义 .env 路由某些情况下不生效的问题

Version: v1.13.0

