# Upgrading To v1.17 From v1.16

## Exciting New Features ðŸŽ‰

- [Goravel Lite](#goravel-lite)
- [Simplified Code Structure](#simplified-code-structure)
- [Process Facade](#process-facade)
- [Pluralizer Package](#pluralizer-package)
- [Service Provider Runners](#service-provider-runners)

## Enhancements ðŸš€

- [facades can be installed and uninstalled as needed](#facades-can-be-installed-and-uninstalled-as-needed)
- [Mail can be sent via template](#mail-can-be-sent-via-template)
- [The build command supports more flags](#the-build-command-supports-more-flags)
- [Add and modify functions for DB and Orm](#add-and-modify-functions-for-db-and-orm)
- [Add new functions for Schema](#add-new-functions-for-schema)
- [Add new commands](#add-new-commands)
- [Add csrf token middleware](#add-csrf-token-middleware)
- [Command supports configure Arguments](#command-supports-configure-arguments)
- [make:migration supports create migration via model](#make-migration-supports-create-migration-via-model)
- [Optimize gRPC client connections](#optimize-grpc-connections)
- [Log supports print json format](#log-supports-print-json-format)
- [Http supports multiple clients](#http-supports-multiple-clients)
- [Validation supports pass context](#validation-supports-pass-context)
- [Add WithoutGlobalScopes function for Orm](#add-withoutglobalscopes-function-for-orm)

## Breaking Changes ðŸ› 

- [Remove machinery queue driver](#remove-machinery-queue-driver)
- [Switch log driver](#switch-log-driver)
- [Optimize migrate:rollback command](#optimize-migrate-rollback-command)
- [Remove Http.Request.Bind function](#remove-http-request-bind-function)

## Upgrade Guide

As [Golang v1.23 is no longer maintained](https://endoflife.date/go), the Golang version of Goravel supports has been upgraded from 1.23 to 1.24.

goravel/example project from v1.16 to v1.17 PR can be used as an upgrade reference: [goravel/example#93](https://github.com/goravel/example/pull/93).

### 1. Update Dependencies

```shell
go get github.com/goravel/framework@latest

// If using gin
go get github.com/goravel/gin@latest

// If using fiber
go get github.com/goravel/fiber@latest

// If using redis
go get github.com/goravel/redis@latest

// If using S3
go get github.com/goravel/s3@latest

// If using Oss
go get github.com/goravel/oss@latest

// If using Cos
go get github.com/goravel/cos@latest

// If using Minio
go get github.com/goravel/minio@latest

go mod tidy
```

### 2. Modify Http Client Configuration

Add new configuration in `config/http.go`:

```go
-- "client": map[string]any{
--   "base_url":                config.GetString("HTTP_CLIENT_BASE_URL"),
--   "timeout":                 config.GetDuration("HTTP_CLIENT_TIMEOUT"),
--   "max_idle_conns":          config.GetInt("HTTP_CLIENT_MAX_IDLE_CONNS"),
--   "max_idle_conns_per_host": config.GetInt("HTTP_CLIENT_MAX_IDLE_CONNS_PER_HOST"),
--   "max_conns_per_host":      config.GetInt("HTTP_CLIENT_MAX_CONN_PER_HOST"),
--   "idle_conn_timeout":       config.GetDuration("HTTP_CLIENT_IDLE_CONN_TIMEOUT"),
-- },
++ "default_client": config.Env("HTTP_CLIENT_DEFAULT", "default"),
++ "clients": map[string]any{
++   "default": map[string]any{
++     "base_url": config.Env("HTTP_CLIENT_BASE_URL", ""),
++     "timeout": config.Env("HTTP_CLIENT_TIMEOUT", "30s"),
++     "max_idle_conns": config.Env("HTTP_CLIENT_MAX_IDLE_CONNS", 100),
++     "max_idle_conns_per_host": config.Env("HTTP_CLIENT_MAX_IDLE_CONNS_PER_HOST", 2),
++     "max_conns_per_host": config.Env("HTTP_CLIENT_MAX_CONN_PER_HOST", 0),
++     "idle_conn_timeout": config.Env("HTTP_CLIENT_IDLE_CONN_TIMEOUT", "90s"),
++   },
++ },
```

### 3. If you want to send mail via template

Add new configuration in `config/mail.go`:

```go
// Template Configuration
//
// This controls template rendering for email views. Template engines are cached
// globally and support both built-in drivers and custom implementations via factories.
//
// Available Drivers: "html", "custom"
"template": map[string]any{
  "default": config.Env("MAIL_TEMPLATE_ENGINE", "html"),
  "engines": map[string]any{
    "html": map[string]any{
      "driver": "html",
      "path":   config.Env("MAIL_VIEWS_PATH", "resources/views/mail"),
    },
  },
},
```

### 4. If you are using machinery queue driver

Need to modify accordingly: [Remove machinery queue driver](#remove-machinery-queue-driver)

### 5. If you created a custom log driver

Need to modify accordingly: [Switch log driver](#switch-log-driver)

### 6. If you are using Http.Request.Bind function

Need to modify accordingly: [Remove Http.Request.Bind function](#remove-http-request-bind-function)

### 7. If you are using validation.Make function or custom rules/filters

Need to modify accordingly: [Validation supports pass context](#validation-supports-pass-context)

### 8. If you are using global scopes in Orm

Need to modify accordingly: [Add WithoutGlobalScopes function for Orm](#add-withoutglobalscopes-function-for-orm)

## Feature Introduction

### Goravel Lite

We are excited to introduce [Goravel Lite](https://github.com/goravel/goravel-lite), a lightweight version of the Goravel framework, designed for developers who want to build applications with minimal dependencies and a smaller footprint. It provides the core features of Goravel while allowing developers to add only the components they need.

- Only includes essential facades: `Artisan`, `Config`, reducing bloat and improving performance.
- Other facades can be installed and uninstalled as needed via the `package:install` and `package:uninstall` commands.
- `goravel/goravel` == `goravel/goravel-lite` + all facades. Any improvements for `goravel/goravel` should be submitted to `goravel/goravel-lite`, then a specify github action will sync the changes to `goravel/goravel`. And `goravel/goravel` is still the main repository for users to use Goravel framework.
- `goravel/installer` will use `goravel/goravel-lite` as the default framework to create new Goravel projects, users can choose to install needed facades.

### Simplified code structure

The code structure has been simplified to improve maintainability and readability to consitent with Laravel. The old structure can still be used, it's a backward compatible change. It's a bit complicated to migrate from old structure to new structure, there is an example PR for reference if needed: [goravel/example#91](https://github.com/goravel/example/pull/91).

1. Remove all `kenel.go` and default `*_service_providers.go` files. Move configurations in `*_service_providers.go` files to the `bootstrap` folder.
2. Move all facades from framework intenal to the `app/facades` folder, users can customize or extend them as needed.
3. Simplify the facades startup process, no need to run facades in `main.go` anymorem, please refer to [Service Provider Runners](../architecture-concepts/service-providers.md#runners) for more details.
4. Support customize directory structure via the `WithPath()` function, please refer to [Customize Directory Structure](../getting-started/directory-structure.md#customize-directory-structure) for more details.

### Process Facade

Goravel now provides an expressive and elegant API around Go's standard `os/exec` package, allowing you to invoke external commands from your application seamlessly.

[View Document](../digging-deeper/processes.md)

### Pluralizer package

Goravel now includes a pluralizer package that helps with converting words between singular and plural forms based on language rules. This is useful for applications that need to handle different languages and their grammatical rules.

[View Document](../digging-deeper/pluralization.md)

### Service Provider Runners

Service Providers can now implement the `Runners` interface to run code when the application starts. This is typically used to start or shutdown services defined in the Service Provider, such as Route, Schedule, Queue, etc. You no longer need to start or shutdown these services manually in `main.go`, as Goravel will handle it for you.

This feature is only available when using [the new simplified code structure](#simplified-code-structure).

[View Document](../architecture-concepts/service-providers.md#runners)

### Log supports print json format

Goravel's logging system now supports outputting logs in JSON format, making it easier to integrate with log management systems and perform structured logging.

```go
"channels": map[string]any{
  "daily": map[string]any{
    "driver":    "daily",
    "path":      "storage/logs/goravel.log",
    "level":     config.Env("LOG_LEVEL", "debug"),
    "days":      7,
    "print":     true,
++  "formatter": "json",// the value can be "text" or "json"
  },
},
```

### Http supports multiple clients

Goravel's HTTP client module now supports multiple clients, allowing you to define and use different HTTP clients with their own configurations for various purposes within your application.

[View Document](../digging-deeper/http-client.md#making-requests)

### Validation supports pass context

Goravel's validation module now supports passing context to validation functions, enabling more flexible and dynamic validation scenarios based on the context of the request or operation.

```go
-- validator, err := facades.Validation().Make(input, rules)
++ validator, err := facades.Validation().Make(ctx, input, rules)
```

Custom rules and filters also support context parameter:

```go
type Rule interface {
	Signature() string
--	Passes(data Data, val any, options ...any) bool
--	Message() string
++	Passes(ctx context.Context, data Data, val any, options ...any) bool
++	Message(ctx context.Context) string
}

type Filter interface {
  Signature() string
--  Handle() any
++  Handle(ctx context.Context) any
}
```

### Add WithoutGlobalScopes function for Orm

A new `WithoutGlobalScopes` function has been added to the Orm package, allowing you to exclude all global scopes from a query. This is useful when you want to retrieve records without the constraints imposed by global scopes.

```go
var user []User
err := facades.Orm().Model(&User{}).WithoutGlobalScopes().Get(&user)
err := facades.Orm().Model(&User{}).WithoutGlobalScopes("name").Get(&user)
```

In order to support set global scope name, the `GlobalScope` interface of model has been modified:

```go
import "github.com/goravel/framework/contracts/orm"

type User struct {
  orm.Model
  Name string
}

-- func (r *User) GlobalScopes() []func(orm.Query) orm.Query {
++ func (r *User) GlobalScopes() map[string]func(orm.Query) orm.Query {
  return map[string]func(orm.Query) orm.Query{
    "name": func(query orm.Query) orm.Query {
      return query.Where("name", "goravel")
    },
  }
}
```

### facades can be installed and uninstalled as needed

Follow the release of [Goravel Lite](#goravel-lite), now facades can be installed and uninstalled as needed via the `package:install` and `package:uninstall` commands. Notice: this feature is only available when you project is built with Goravel Lite or upgrades to [the new simplified code structure](#simplified-code-structure).

[View Document](../architecture-concepts/facades.md#install-uninstall-facades)

### Mail can be sent via template

Mail sending now supports templates, allowing you to send emails using predefined templates for better consistency and easier management. The template supports http and custom drivers.

[View Document](../digging-deeper/mail.md#using-template)

### The build command supports more flags

Add new `--arch` and `--static` flags to the `build` command, allowing you to specify the target architecture and whether to build a static binary.

### Add and modify functions for DB and Orm

New functions:

- `Avg(column string, dest any) error`: Calculate the average value of a column.
- `Min(column string, dest any) error`: Find the minimum value of a column.
- `Max(column string, dest any) error`: Find the maximum value of a column.
- `WhereAll(columns []string, args ...any) Query`: Adds a "where all columns match" clause to the query.
- `WhereAny(columns []string, args ...any) Query`: Adds a "where any column matches" clause to the query.
- `WhereNone(columns []string, args ...any) Query`: Adds a "where none of the columns match" clause to the query.

Modified functions:

```go
// Before
Sum(column string) (int64, error)

// After
Sum(column string, dest any) error
```

### Add new functions for Schema

New functions have been added to the Schema package to enhance database schema management capabilities.

- `DateTimes`: Create `created_at` and `updated_at` columns on the table.
- `ForeignID`: Create an unsigned big integer column for foreign keys.
- `ForeignUlid`: Create a ULID column for foreign keys.
- `ForeignUuid`: Create a UUID column for foreign keys.

### Add new commands

- `make:provider`: Create a new service provider class.
- `make:view`: Create a new view template file.

### Add csrf token middleware

A new middleware has been added to protect against Cross-Site Request Forgery (CSRF) attacks. This middleware can be applied to routes to ensure that requests are coming from authenticated sources.

[View Document](../the-basics/views.md#csrf-token-middleware)

### Command supports configure Arguments

Commands now support configuring arguments, allowing you to define and handle command-line arguments more effectively within your custom commands.

[View Document](../digging-deeper/artisan-console.md#arguments)

### make:migration supports create migration via model

The `make:migration` command has been enhanced to support creating migrations based on existing models. This allows for quicker migration creation by leveraging the structure defined in your models.

[View Document](../database/migrations.md#create-migrations)

### Optimize gRPC client connections

A client connection pool has been implemented for gRPC clients to optimize performance and resource utilization. This allows for reusing existing connections rather than creating new ones for each request, reducing latency and improving efficiency.

### Remove machinery queue driver

The machinery queue driver has been removed totally given it's deprecated in v1.16. Please follow the guidelines in the [v1.16 upgrade document](./v1.16.md#optimize-queue-module-configuration) to migrate to other queue drivers if you are still using it.

### Switch log driver

The log driver has been switched from `logrus` to `log/slog` for better performance and structured logging capabilities.

The custom log driver interface has been modified:

```go
// framework/contracts/log/Logger
package log

type Logger interface {
  // Handle pass channel config path here
--  Handle(channel string) (Hook, error)
++  Handle(channel string) (Handler, error)
}
```

You can use `log.HookToHandler` function to adapt old custom log drivers:

```go
type CustomLogger struct {}

func (logger *CustomLogger) Handle(channel string) (log.Handler, error) {
  hook := /* your old custom log driver logic */
  
  return log.HookToHandler(hook), nil
}
```

### Optimize migrate:rollback command

Previously, the `migrate:rollback` command only rolls back one migration at a time, it's not consistent with Laravel's behavior. Now the command will roll back all migrations from the last batch by default. You can still use the `--step` option to specify the number of batches to roll back.

### Remove Http.Request.Bind function

The `Bind` function on the `Http.Request` interface has been removed. You can now use the `Bind` method via `response`.

```go
var user User
-- response, err := facades.Http().Bind(&user).Get("https://github.com")
++ response, err := facades.Http().Get("https://github.com")
++ err = response.Bind(&user)
```
